<div>
	<div style="margin: 3px; float: left;">
		<?php echo $this->form; ?>
	</div>
	<div style="float: right; margin: 7px">
		<a href="/pub/">Pubs (Internal)</a> |
		<a href="/index/share">Share</a> | <div class="fb-login-button" style="display: inline">Login with Facebook</div> | <a href="#">Tell a friend</a>
	</div>
	<div style="clear: both;"></div>
</div>
<div id="map_canvas" style="height:95%"></div>
<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0; padding: 0 }
  #map_canvas { height: 100% }
</style>
<script type="text/javascript"
    src="http://maps.googleapis.com/maps/api/js?sensor=true&libraries=places">
</script>
<script type="text/javascript">

thirsty.long = '<?php echo $this->long; ?>';
thirsty.lat = '<?php echo $this->lat; ?>';
thirsty.mapMarkers = [];

function cleanMarkers() {
    if (thirsty.mapMarkers) {
        for (var i = 0; i < thirsty.mapMarkers.length; i++ ) {
            thirsty.mapMarkers[i].setMap(null);
        }
    }
}

function setMarkers(data) {
    cleanMarkers();
    markers = data;

    var bounds = new google.maps.LatLngBounds();
    var customIcons = {
        restaurant: {
            icon: '/img/icons/markers/steak.png'
        },
        bar: {
            icon: '/img/icons/markers/beer.png'
        }
    };

    for (var i = 0; i < markers.length; i++) {
        var marker = markers[i];
        var name = marker.name[0];
        var address = marker.address[0];
        var type = marker.type[0];

        var point = new google.maps.LatLng(
            parseFloat(marker.lat[0]),
            parseFloat(marker.lng[0]));

        if (markers.length < 50) {
            bounds.extend(point);
        }

        var icon = customIcons[type] || {};

        var mapMarker = new google.maps.Marker({
            map: thirsty.map,
            position: point,
            icon: icon.icon,
            shadow: icon.shadow,
            html: "<b>" + name + "</b> <br />" + address + '<br /><a href="/pub/overview/id/' + marker.id[0] + '">More info</a>'
        });

        thirsty.mapMarkers.push(mapMarker);
        google.maps.event.addListener(mapMarker, 'click', function() {
            thirsty.infoWindow.setContent(this.html);
            thirsty.infoWindow.open(thirsty.map, this);
        });
    }

    if (markers.length < 50) {
        thirsty.map.fitBounds(bounds);
    }
}

$(document).ready(function() {
 
    var amHere = new google.maps.LatLng(thirsty.lat, thirsty.long);
    var myOptions = {
        zoom: 15,
        center: amHere,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    thirsty.map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

    thirsty.infoWindow = new google.maps.InfoWindow();

    customIcons = {
        restaurant: {
            icon: '/img/icons/markers/steak.png'
        },
        bar: {
            icon: '/img/icons/markers/beer.png'
        }
    };

    $.ajax({success: function(data) {setMarkers(data);}, 
            url: '/map/fetch/lat/' + amHere.Oa + '/long/' + amHere.Pa, dataType: 'json'});

    $("#searchForm").submit(function() {
        $.ajax({
            success: function(data) {
                setMarkers(data);
            }, 
            url: '/map/search/q/' + $("#location").val(), dataType: 'json'
        });
        
        return false;
    });

});
</script>