
<div id="header" style="margin: 0;">
    <a style="float: left;" id="logo" href="/">Dunia</a>
	<div style="margin: 3px; float: left;">
		<?php echo $this->form; ?>
	</div>
	<div style="float: right; margin: 7px">
		<?php echo $this->render('partials/nav.phtml'); ?>
   	</div>
	<div style="clear: both;"></div>
</div>
<div id="map_canvas" style="height:95%;"></div>

<script type="text/javascript">

thirsty.long = '<?php echo $this->long; ?>';
thirsty.lat = '<?php echo $this->lat; ?>';
thirsty.mapMarkers = [];

function cleanMarkers() {
    if (thirsty.mapMarkers) {
        for (var i = 0; i < thirsty.mapMarkers.length; i++ ) {
            thirsty.mapMarkers[i].setMap(null);
        }
    }
}

function setMarkers(data) {
    cleanMarkers();
    var markers = data;

    var customIcons = {
        now: {
            icon: '/img/icons/markers/half.png'
        },
        earlier: {
            icon: '/img/icons/markers/empty.png'
        },
        later: {
            icon: '/img/icons/markers/full.png'
        }
    };

    for (var i = 0; i < markers.length; i++) {
        var marker = markers[i];
        var name = marker.name[0];
        var address = marker.address[0];
        var type = marker.itsOn[0];
        var point = new google.maps.LatLng(
            parseFloat(marker.lat[0]),
            parseFloat(marker.lng[0]));

        var icon = customIcons[type] || {};

        var mapMarker = new google.maps.Marker({
            map: thirsty.map,
            position: point,
            icon: icon.icon,
            shadow: icon.shadow,
            html: "<b>" + name + "</b> <br />" + address + '<br /><a href="/pub/overview/id/' + marker.id[0] + '">More info</a>'
        });

        thirsty.mapMarkers.push(mapMarker);
        google.maps.event.addListener(mapMarker, 'click', function() {
            thirsty.infoWindow.setContent(this.html);
            thirsty.infoWindow.open(thirsty.map, this);
        });
    }
}

$(document).ready(function() {
 
    var amHere = new google.maps.LatLng(thirsty.lat, thirsty.long);

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {

            var longitude = position.coords.longitude;
            var latitude  = position.coords.latitude;

            var currentPosition = new google.maps.LatLng(latitude, longitude);

            new google.maps.Marker({
                map: thirsty.map,
                position: currentPosition,
                icon: '/img/icons/markers/current.png'
            });
            thirsty.map.panTo(currentPosition);
        });
    }

    var myOptions = {
        zoom: 15,
        center: amHere,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    thirsty.map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

    thirsty.infoWindow = new google.maps.InfoWindow();

    customIcons = {
        restaurant: {
            icon: '/img/icons/markers/steak.png'
        },
        bar: {
            icon: '/img/icons/markers/beer.png'
        }
    };

    $.ajax({success: function(data) {setMarkers(data);}, 
            url: '/map/fetch/lat/' + thirsty.lat + '/long/' + thirsty.long, dataType: 'json'});

    $("#searchForm").submit(function() {
        $.ajax({
            success: function(data) {
                setMarkers(data);
            }, 
            url: '/map/search/q/' + $("#location").val(), dataType: 'json'
        });
        
        return false;
    });

});
</script>