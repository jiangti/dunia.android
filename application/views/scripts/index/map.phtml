<div data-role="page" class="page">
    <div class="home" data-role="header" data-add-back-btn="true">
        <a href="/" class="navButton" data-role="none" data-transition="flip">
            <img src="/img/icons/navbar/53-house-shadow.png" width="24" height="28" />
        </a>
        <h1><img src="/img/dunia.png" width="82" height="25" /></h1>
        <a href="#" id="locate" class="navButton" data-role="none">
            <img src="/img/icons/navbar/74-location-shadow.png" width="24" height="28" />
        </a>
    </div>

    <div data-role="content" style="height: 95%; padding: 0">
        <script type="text/javascript">
            $(document).ready(function() {
                var mobileDemo = { 'center': '-33.8757,151.206', 'zoom': 15 };
                var currentPosition = null;
                var googlemap       = null;

                $('#map_canvas').gmap({'center': mobileDemo.center, 'zoom': mobileDemo.zoom, 'disableDefaultUI':true, 'callback': function() {
                    var self = this;
                    googlemap = self.get('map');

                    var customIcons = {
                        now: {
                            icon: '/img/icons/markers/half.png'
                        },
                        earlier: {
                            icon: '/img/icons/markers/empty.png'
                        },
                        later: {
                            icon: '/img/icons/markers/full.png'
                        },
                        none: {
                            icon: '/img/icons/markers/bar.png'
                        }
                    };

                    <?php foreach ($this->pubs as $pub): ?>
                    var type = '<?php echo $pub['itsOn']; ?>';
                    var icon = customIcons[type] || {};

                    self.addMarker({'icon' : icon.icon, 'position': new google.maps.LatLng(<?php echo $pub['latitude']; ?>, <?php echo $pub['longitude']; ?>) }).click(function() {
                        self.openInfoWindow({ 'content': '<?php echo addslashes($pub['name']); ?>' }, this);
                    });
                    <?php endforeach; ?>

                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            var address   = position.address;
                            var longitude = position.coords.longitude;
                            var latitude  = position.coords.latitude;

                            if (address) {
                                $("#footer").html("<p>Near " + address.streetNumber + ' ' + address.street + ' in ' + address.city + '</p>');
                            } else {
                                var geocoder = new google.maps.Geocoder();
                                var latlng   = new google.maps.LatLng(latitude, longitude);

                                geocoder.geocode({'latLng': latlng}, function(results, status) {
                                    if (status == google.maps.GeocoderStatus.OK) {
                                        if (results[0]) {
                                            var components = results[0].address_components;
                                            $("#footer").html("<p>Near " + components[0].long_name + ' ' + components[1].long_name + ', ' + components[2].long_name + '</p>');
                                        }
                                    }
                                });
                            }

                            currentPosition = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                            var blueIcon = new google.maps.MarkerImage("http://gmaps-samples.googlecode.com/svn/trunk/markers/blue/blank.png");

                            self.addMarker({'position': currentPosition, icon: '/img/icons/markers/current.png' }).click(function() {
                                self.openInfoWindow({ 'content': '<?php echo addslashes($pub['name']); ?>' }, this);
                            });

                            googlemap.panTo(currentPosition);
                        });
                    }
                }});

                $('#locate').click(function() {
                    if (currentPosition && googlemap) {
                        googlemap.panTo(currentPosition);
                    }
                    return false;
                });

            });
        </script>
        <div id="map_canvas" style="z-index: 0;height:100%;min-height:300px;"></div>
    </div>

    <div id="footer" data-role="footer" data-position="fixed"/>
</div>
</body>
</html>
